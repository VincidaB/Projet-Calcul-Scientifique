\documentclass[fleqn]{article}
\usepackage[utf8]{inputenc}

\title{Compte rendu\\ Projet de Calcul Scientifique Numérique} 
\author{Belpois Vincent \\ Chomette Hugo}
\date{}
\usepackage[fleqn]{mathtools}
\usepackage{amssymb}
\usepackage{enumitem}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{geometry}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{esint}          % various fancy integral symbols
\usepackage{upgreek}
\usepackage{parskip}
\usepackage[b]{esvect}      %For better vectors
\usepackage{float}
\usepackage{tikz}
\usepackage{pdflscape}

\usepackage{pythonhighlight}

\usepackage{hyperref}
\hypersetup{
    colorlinks,
    citecolor=black,
    filecolor=black,
    linkcolor=black,
    urlcolor=black
}


\geometry{hmargin=2.5cm,vmargin=2cm}

\usepackage{sectsty}
%\sectionfont{\color{red}}
%\subsectionfont{\color{red}}
%\renewcommand{\thesection}{\color{red} \Roman{section}\color{black} } 
%\renewcommand{\thesubsection}{{ \indent \arabic{subsection}) }}
%\renewcommand{\thesubsubsection}{\indent \indent \alph{subsubsection}.} 
\renewcommand*\contentsname{Table des matières}

\renewcommand{\epsilon}{\varepsilon} 
\renewcommand{\phi}{\varphi} 
\newcommand{\dd}{\text{d}}

\let\vect\overrightarrow
\let\mc\mathcal




\setlist[1]{noitemsep}



\begin{document}
\maketitle
\newpage

\tableofcontents
\newpage

\section{Présentation du problème}
\subsection{Le problème}
On modélise un thermocouple par une sphère uniforme de rayon $a$. Cette sphère, initialement à la température $T_0$, échange convectivement avec le milieu extérieur, à la température $T_\infty$, selon la loi $\phi = h(\theta) ( T - T_\infty)$. 
\begin{figure}[H]
    \centering
    \begin{tikzpicture}
        \shade[ball color = gray!40, opacity = 0.4] (0,0) circle (2cm);
        \draw (0,0) circle (2cm);
        \draw (-2,0) arc (180:360:2 and 0.6);
        \draw[dashed] (2,0) arc (0:180:2 and 0.6);
        \fill[fill=black] (0,0) circle (1pt);
        \draw[dashed] (0,0 ) -- node[below]{$a$} (2,0);
        \draw (0,0) -- ({2*cos(20)},{2*sin(20)});
        \draw (1,0) arc (0:20:1);
        \node at (1.1,0.2) {$\theta$};
        \node at (1.9,0.8) [right]{$\phi = h(\theta) ( T - T_\infty)$};
        \node at (-5, 0) {$T_\infty$};
        \node at (-1,1) {$T_0$};
    \end{tikzpicture}
    \caption{Schéma du Thermocouple}
\end{figure}


On cherche alors à étudier la réponse de ce thermocouple au cours du temps. Pour cela, on s'impose l'utilisation de la méthode des différences finies


\subsection{Interprétation des coéficients}
La fonction $h(\theta)$ décrit la dépendance de la convection avec l'angle $\theta$ entre la normale à la surface de la sphère et la direction de l'échange thermique. Plus précisément, la quantité de chaleur échangée par convection entre la sphère et le milieu extérieur est proportionnelle à la différence de température entre la sphère et le milieu extérieur, multipliée par $h(\theta)$.

La forme de la fonction $h(\theta) = K (1 + \cos(\theta))$ indique que l'échange de chaleur par convection est maximale lorsque la normale à la surface de la sphère est parallèle à la direction de l'échange thermique et dans le me sens que celui-ci, c'est-à-dire lorsque $\theta = 0^\circ$. Dans ces cas, $h(\theta) = K (1 + 1) = 2K$. L'échange de chaleur par convection est minimale lorsque la normale à la surface de la sphère est dans le sens opposé à celui de l'échange thermique, c'est-à-dire lorsque $\theta = 180^\circ$. Dans ce cas, $h(\theta) = K (1 - 1) = 0$.

La constante $K$ détermine l'intensité de l'échange de chaleur par convection pour un angle $\theta$ donné. Plus $K$ est grand, plus l'échange de chaleur par convection est important. $K$ est alors exprimé en $W.m^{-2}.K^{-1}$, tout comme $h(\theta)$.

\subsection{Mise en équation du problème}
Ce problème revient alors a résoudre l'équation de la chaleur en 3 dimmensions et au cours du temps.
De manière générale, l'équation de la chaleur s'écrit de la manière suivante.
\begin{equation}
    \rho C_p \left(  \frac{ \partial T}{\partial t} + u \cdot \nabla T \right) = \nabla \cdot ( \lambda  \nabla T) + s
\end{equation}

Dans notre cas, cette équation peut être simplifiée. On a premièrement $u = 0$ car la sphère n'est pas en mouvement. De plus, lambda est constant, on a donc par linéaritée du gradiant $\nabla ( \lambda \nabla T ) = \lambda \nabla^2 T$. Enfin, le thermocouple n'étant traversé par aucun courant électrique, aucune chaleur n'est produit en sont sein et don cle terme de source $s$ est nul.

L'équation de la chaleur devient alors :
\begin{equation}
    \rho C_p   \frac{ \partial T}{\partial t} = \lambda\nabla^2 T
    \label{equation_de_la_chaleur}
\end{equation}

On peut aussi écrire une condition a la surface de la sphère, représentant un échange convectif :
\[
\phi = h(\theta)(T-T_\infty)
\] 
Avec $h(\theta)$ le coéficient de convection exprimé précédement.


\newpage
\section{Choix du système de coordonnées et du maillage}
\subsection{Comparaison des systèmes de coordonnées cartésiennes et sphériques}
\subsubsection{Coordonnées cartésiennes}
Le système de coordonnées cartésiennes a l'avantage d'utiliser un repère orthonormé. L'expression des opérateurs tels que le laplacien est donc simple et les équation sont alors simplifiées. Cependant, si le maillage n'est pas régulier selon les trois axes du système de coordonnées cartésiennes, l'expression du pas est alors plus complexe.

\begin{figure}[H]
    \centering
    \textbf{AJOUTER PETIT REPERE CARTESIEN}
\end{figure}

\subsubsection{Coordonnées sphériques}
Le problème décrivant une sphère, le seul système de coordonnées qui peut être intéressant à utiliser est le système de coordonnées sphériques. Ce système de coordonnées est aussi constitué de trois axes orthonormés:$\vv{e_r}, \vv{e_\theta}, \vv{e_\phi}$ . On utilisera alors pour décrire la position d'un point un triplet de coordonées $(r, \theta, \phi)$. 

\begin{figure}[H]
    \centering
    \textbf{AJOUTER PETIT REPERE SPHERIQUE}
\end{figure}


Pour passer des coordonées cartésiennes aux coordonées sphériques on utilise les équtions suivantes :
\begin{equation}
    \begin{cases}
        r = \sqrt{x^2 + y^2 + z^2} \\
        \theta = \arccos \left( \frac{z}{r} \right)\\
        \phi = \arctan \left( \frac{y}{x} \right)
    \end{cases}
\end{equation}

De la même manière, pour passer des coordonnées sphériques aux coordonnées cartésiennes on utilise les équations suivantes :
\begin{equation}
    \begin{cases}
        x&=r \sin \theta \cos \varphi \\
        y&=r \sin \theta \sin \varphi \\
        z&=r \cos \theta 
    \end{cases}
    \label{Polar coord}
\end{equation}

\subsection{Réécriture des équations adaptée au nouveau système de coordonnées}
 
L'équation de la chaleur Eq.\eqref{equation_de_la_chaleur} utlise l'opérateur laplacien ($\Delta = \nabla^2$). Cet opérateur s'écrit en coordonnées cartésiennes :

\begin{equation}
    \Delta f = {\frac {\partial ^{2}f }{\partial x^{2}}}+{\frac {\partial ^{2}f }{\partial y^{2}}}+{\frac {\partial ^{2}f }{\partial z^{2}}}
\end{equation}

En coordonnées sphérique, cet opératreur s'écrit alors :
\begin{equation}
     \Delta f={\frac {\partial ^{2}f}{\partial r^{2}}}+{\frac {1}{r}}{\frac {\partial f}{\partial r}}+{\frac {1}{r^{2}}}{\frac {\partial ^{2}f}{\partial \theta ^{2}}}+{\frac {1}{r^{2}\tan \theta }}{\frac {\partial f}{\partial \theta }}+{\frac {1}{r^{2}\sin ^{2}\theta }}{\frac {\partial ^{2}f}{\partial \varphi ^{2}}}
\end{equation}

L'équation de la chaleur Eq.\eqref{equation_de_la_chaleur} s'écrit alors :
\begin{equation}
    \rho C_p \frac{ \partial T}{\partial t}  = \lambda \left( 
    {\frac {\partial ^{2}T}{\partial r^{2}}}+{\frac {1}{r}}{\frac {\partial T}{\partial r}}+{\frac {1}{r^{2}}}{\frac {\partial ^{2}T}{\partial \theta ^{2}}}+{\frac {1}{r^{2}\tan \theta }}{\frac {\partial T}{\partial \theta }}+{\frac {1}{r^{2}\sin ^{2}\theta }}{\frac {\partial ^{2}T}{\partial \varphi ^{2}}} \right)      
\end{equation}
Dans la suite du problème on utilisera la constante $\alpha = \frac{\lambda}{\rho C_p}$ afin de simplifier l'écriture de l'équation ci-dessus.

\subsection{Maillage de la sphère}
Une sphère peut être mailler de plusieurs mainères dans un espace 3D, certains maillage favoriseront l'uniformité de la taille des mailles comme les maillages quandrangulaires ou en géode par triangulation tandis que d'autres faciliterons la résolution numérique du problème comme le maillage en sphère UV (maillage en faces rectangulaires, formé par des segments assimilables a des lignes de longitude et de latitude sur un globe).

\begin{figure}[H]
    \centering
    \textbf{AJOUTER PETIT SPHERE QUANDRAGULAIRE, GEODE(ISO) et UV}
\end{figure}

On utilisera dans le cadre de notre simulation un maillage UV de la sphère, ce modèle se prettant très bien au systèe de coordonnées sphérique. Cela simplifiera les calculs et l'implémentation des équations.

Les paramètres pour construire ce maillage seront alors \texttt{Nr, Ntheta, Nphi}, représentant respectivement le nombre de mailles dans la direction $r$, la direction $\theta$, et la direction $\phi$ 

On repèrera par le triplet $(i,j,k)$ les coordonées du noeud du maillage de la sphère. 

\newpage
\section{Discrétisation du problème} 
La méthode utilisée ici est la méthode des différences finies. On choisi d'utiliser l'ordre 1 afin de simplifier les expressions des termes de l'équation de la chaleur, un ordre supérieur pourra être utilisé afin d'augmenter la précision et la stabilité si nécessaire.
\subsection{Discrétisation de l'équation de la chaleur}
On rapelle l'équation de la chaleur utilisée :

\begin{equation}
    \frac{ \partial T}{\partial t}  =  \alpha \nabla^2 T
\end{equation}

Et donc en coordonées sphériques, en prenant en compte l'invariance du champ de température par rapport à $\phi$  :

\begin{equation}
    \frac{ \partial T}{\partial t}  = \alpha \left( 
    {\frac {\partial ^{2}T}{\partial r^{2}}}+{\frac {1}{r}}{\frac {\partial T}{\partial r}}+{\frac {1}{r^{2}}}{\frac {\partial ^{2}T}{\partial \theta ^{2}}}+{\frac {1}{r^{2}\tan \theta }}{\frac {\partial T}{\partial \theta }} \right)      
\end{equation}

On cherceh a exprimer $T^n $ en fonction uniquement de $T^{n-1}$ On utilise alors un schéma arrière temporel. : 

\begin{equation}
    \frac{ \partial T}{\partial t} \rightarrow  \frac{T^n - T^{n-1}}{\Delta t} 
\end{equation}

On discrétise ensuite avec un schéma centré les termes issus du laplacien de la température :


\begin{equation}
    \frac{ \partial ^2 T}{\partial r^2} \rightarrow 
    \frac{T_{i+1,j,k}^{n-1} - 2 T_{i,j,k}^{n-1} + T_{i-1,j,k}^{n-1}}{\Delta r^2}
\end{equation}

\begin{equation}
    \frac{1}{r}\frac{ \partial T}{\partial r} \rightarrow 
    \frac{1}{r_i}\frac{T_{i+1,j,k}^{n-1} - T_{i-1,j,k}^{n-1}}{\Delta r}
\end{equation}

\begin{equation}
    \frac{1}{r^2}\frac{ \partial^2 T}{\partial \theta^2} \rightarrow 
    \frac{1}{r_i^2}\frac{T_{i,j+1,k}^{n-1} - 2 T_{i,j,k}^{n-1} + T_{i,j-1,k}^{n-1}}{\Delta \theta^2}
\end{equation}

\begin{equation}
    \frac{1}{r^2 \tan \theta}\frac{ \partial T}{\partial \theta} \rightarrow 
    \frac{1}{r_i^2 \tan \theta_j }\frac{T_{i,j+1,k}^{n-1} - T_{i,j-1,k}^{n-1}}{2\Delta \theta}
\end{equation}


On peut alors exprimer $T^n$ :

\begin{multline}
    T^n = \alpha \Delta t  \left( \frac{T_{i+1,j,k}^{n-1} - 2 T_{i,j,k}^{n-1} + T_{i-1,j,k}^{n-1}}{\Delta r^2}+\frac{1}{r_i}\frac{T_{i+1,j,k}^{n-1} - T_{i-1,j,k}^{n-1}}{\Delta r} + \frac{1}{r_i^2}\frac{T_{i,j+1,k}^{n-1} - 2 T_{i,j,k}^{n-1} + T_{i,j-1,k}^{n-1}}{\Delta \theta^2}\right. \\
    +\left.\frac{1}{r_i^2 \tan \theta_j }\frac{T_{i,j+1,k}^{n-1} - T_{i,j-1,k}^{n-1}}{2\Delta \theta}\right)  + T^{n-1}
    \label{discretisation Gal}
\end{multline}


\subsection{Discrétisation des condition aux limites}

On doit par la suite discrétiser notre condition à la surface de la sphère que l'on rappelle être :
\begin{equation}
    \phi = h(\theta)(T - T_{\infty})
\end{equation}

On a donc par la loi de Fourier :
\begin{equation}
    h(\theta)(T(r = a) - T_\infty) = -\lambda \left.\frac{ \partial T}{\partial r}\right|_{r=a} 
\end{equation}
On a alors, par les discrétisation des dérivées partielles précédentes :
\begin{equation}
    T_{i,j,k}^n = \left(h(\theta) + \frac{\lambda}{\Delta r}\right)^{-1} \cdot \left( h(\theta) T_\infty + \lambda \frac{T_{i-1,j,k}}{\Delta r}\right)
    \label{discretisation limite}
\end{equation}

Les équations Eq.\eqref{discretisation Gal}et Eq.\eqref{discretisation limite} nous permmettrent alors d'exprimer, en tout point de la sphère, la température en fonction des températures de la sphère l'instant précédent




\newpage
\section{Simulation Python} 
Pour implémenter une telle simulation, nous avons utilisé Python comme language de programmation pour sa facilitée et sa capacitée a visualiser des données à l'aide de bibliothèques simples. La capacitée à executer du code sans compiler nous a aussi permis d'itérerplus rapidement et de débugger simplement le code.
\subsection{Structure du code}
Le code est composé de quelques fonctions simples et notre situation ne semblait pas demander a introduire de la programation orientée objet, car nous avons décidé de représenter les maillages et les simualations commme de simples tableaux \texttt{numpy}. 

Ainsi, on commence dabord par fixer nos constantes de la simulation comme les paramètres de maille, les constantes du matériau considéré, les températures ($T_0$ et $T_\infty$ ), le facteur de convection, etc\dots

On construit ensuite le maillage de la sphère.

Enfin on itère la simulation en stockant chaques maillages de la simulaiton dans une liste.

Finalement, on affiche cette simulation et on enregistre une animation de celle-ci.

\subsection{Implémentation du maillage}
 \subsubsection{Maillage et liste de maillages}
Chaque maillage de a sphère est représenté par une tableau \texttt{numpyarray} de dimmension 4. Les 3 premières coordonnées sont utilisées pour la position (soit $x,y,z$ soit $r, \theta, \phi$ ) tandis que la quatrième est utilisée pour représenté la température de ce noeud. Ainsi on créée un objet \texttt{maillage} de la manière suivante :


\begin{python}
    maillage = np.zeros((Nr,Ntheta,Nphi,4))
    maillage[:,:,:,3] = T0                  #set every node temperature to T_0
    for i in range(Nr):
        for j in range(Ntheta):
            for k in range(Nphi):
                maillage[i,j,k,:3] = ((i)*a/(Nr), (j+0.5)*math.pi/Ntheta, 2*k*math.pi/Nphi)

\end{python}
Les coordonées sont alors données par Eq.\eqref{Polar coord}. On initialise tous les noeuds à la température $T_0$, tempréature initiale du thermocouple supposé uniforme. 

On introduit aussi une fonction permettant d'obtenir le maillage constituté des coordonnées caertésiennes de chaque noeud afin de par la suite pouvoir visualiser ce mailage :
\begin{python}
    def polar_to_cartesian(polar):
        cart = np.copy(polar)
        cart[:,:,:,0] = polar[:,:,:,0] * np.sin(polar[:,:,:,1])*np.cos(polar[:,:,:,2])
        cart[:,:,:,1] = polar[:,:,:,0] * np.sin(polar[:,:,:,1])*np.sin(polar[:,:,:,2])
        cart[:,:,:,2] = polar[:,:,:,0] * np.cos(polar[:,:,:,1])
        return cart
\end{python}

On construit alors une simulation comme étant une liste de différents maillage (les maillages sont physiquement identiques mais la valeur de la température à chaque noeud est différente).
Cela peut se voir dans la fonction \texttt{simulation} qui ajoute a la liste de maillage, le nouveau maillage calculé par la fonction \texttt{compute\_next\_step}:

\begin{python}
    def simulation():
    dt = 0.000001
    meshes = []
    meshes.append(maillage)
    for i in range(25000):
        print(i)
        meshes.append(compute_next_step(meshes[i], dt))
    return meshes
\end{python}

\texttt{meshes} est alors l'ensemble des maillage de notre simulation.

\subsubsection{Visualisation des maillages et des simulations}
On a décidé d'utiliser la librairie \texttt{matplotlib} afin de visualiser nos données car cette librairie peut à la fois permettre de réaliser des visualisation 3D et de simples graphs 2D.

\begin{python}
    from mpl_toolkits.mplot3d import Axes3D
    import matplotlib.animation

    fig = plt.figure()
    fig.set_figheight(15)
    fig.set_figwidth(15)
    ax = fig.add_subplot(111, projection='3d')

    ax.axes.set_xlim3d(left=-0.004, right=0.004) 
    ax.axes.set_ylim3d(bottom=-0.004, top=0.004)
    ax.axes.set_zlim3d(bottom=-0.004, top=0.004)

    norm = matplotlib.colors.Normalize(vmin=380, vmax=451)
\end{python}

On commence par intialiser une figure aec une projection de type '3d'. On fixe alors les limites de l'affichage. Et enfin, on créé la variable \texttt{norm} qui sera utilisé lors de l'afichage des températures par une plage de couleurs.

On doit alors, pour afficher une animation des points qui changent de couleur au cours du temps, créer une fonction qui met a jour la visualisation, et change les données envoyés à \texttt{matplotlib} :
\begin{python}
    def update_graph(num):
        factor = 100
        global k
        mesh_c = polar_to_cartesian((simulation_meshes[num*factor]))
        graph._offsets3d = mesh_c[:,:,:,0].ravel(), mesh_c[:,:,:,1].ravel(), mesh_c[:,:,:,2].ravel()
        
        graph.set_facecolor(cmap_inferno(norm(mesh_c[:,:,:,3].ravel())))
            
        title.set_text('3D Test, num={}'.format(num*factor))
        return title, graph, 
\end{python}

Le paramètre \texttt{factor} est utlisé pour n'afficher que certaines étapes de la simulation, ici toutes les 100 mises a jours du maillage. Dans le cas contraire, la visualisation de l'entièreté de la simulation prendrait des heures.

On peut alors afficher la simulation de la manière suivante :
\begin{python}
    mesh_c = polar_to_cartesian((simulation_meshes[0]))
    graph = ax.scatter(mesh_c[:,:,:,0].ravel(), mesh_c[:,:,:,1].ravel(), mesh_c[:,:,:,2].ravel())
    ani = matplotlib.animation.FuncAnimation(fig, update_graph,249, blit=False)

    plt.show()
    ani.save("simulation.gif", fps=10)
\end{python}

Ici, 249 représente la dernière itération de la simulation que l'on souhaite voir (qui sera multiplié par \texttt{factor} et donc creprésente ici l'itération 24900). On sauvegarde aussi l'animation créé pour de prochaines visualisations.


\subsection{Implémentation des équations}
Les équations discutés dans les parties précédentes sont implémentés dans la fonction \texttt{compute\_next\_step}. Cette fonction prend en paramètre le maillage au temps $n$ et le pas temporel \texttt{dt} et renvoit le nouveau maillage au temps $n+1$.

Dans l'extrais de code qui suit, certaines parties ont été omises afin d'en facilité la lecture. en effet on remarque que plusieurs cas selon la valeur de \texttt{i} ont été disociés. Cela est dû au fait que l'expression du laplacien en différente en 0 et la présence de la condition à la surface de la sphère (en $r=a$). On remarque aussi que des distinctions de cas ont été faites selon la valeur de \texttt{j}. Cela provient des problèmes d'indices ; les indices ne forment pas une boucle lorsque que l'on atteint le dernier indice.

\newpage
\begin{python}
def compute_next_step(p_mesh, dt):
    Nr, Ntheta, Nphi, _ = np.shape(p_mesh)
    n_mesh = np.copy(p_mesh)

    Delta_r = a / Nr
    Delta_theta = math.pi / Ntheta
    Delta_phi = 2 * math.pi / Nphi
    for i in range(0, Nr):
        if i == 0:
            ...
        elif i == Nr - 1:
            ...     
        else:
            r = i * Delta_r
            for j in range(Ntheta):
                theta = (j+1.5) * Delta_theta
                if j == 0:
                    ...
                    
                elif j == Ntheta - 1:
                    ...
                                        
                else:
                    for k in range(Nphi):
                        phi = (k+1) * Delta_phi
                        n_mesh[i,j,k,3] = alpha * dt * 
                    ((p_mesh[i+1,j,k,3]-2*p_mesh[i,j,k,3]+p_mesh[i-1,j,k,3])/(Delta_r**2)
                    + 1/r*(p_mesh[i+1,j,k,3]-p_mesh[i-1,j,k,3]) / Delta_r
+ 1/r**2 * (p_mesh[i,j+1,k,3] - 2 * p_mesh[i,j,k,3] + p_mesh[i,j-1,k,3]) / (Delta_theta**2)
+ 1/(r**2 * math.tan(theta)) * p_mesh[i,j+1,k,3] - p_mesh[i,j-1,k,3] / (2* Delta_theta)) 
+ p_mesh[i,j,k,3]
                        
    return n_mesh
\end{python}

\subsection{Simulations}
\subsubsection{Choix des valeurs des paramètre}
Choix des pas, des dimensions, de Delta t, du temps de simulation
\subsubsection{Test de l'influence de certains paramertres}
\subsubsection{Simulations}

\newpage
\section{Conclusion}
Conclure sur la méthode utilisé, l'implémentation, la convaincance des résultats.

Finir sur ce que cela nous a apris, la facilitée d'implémenter vs la difficultée à discrétiser le probblème et choisir la valeur des paramètres
\end{document}